<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Simulation Setup</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
    <link href="assets/css/style.css" rel="stylesheet">

    <style>
        body {
            font-family: 'Roboto', sans-serif;
            color: #333;
        }

        h1,
        h2,
        h3,
        h4 {
            font-family: 'Roboto', sans-serif;
            font-weight: 700;
            letter-spacing: 0.5px;
            color: #333;
        }

        p {
            font-family: 'Roboto', sans-serif;
            font-size: 16px;
            line-height: 1.6;
            font-weight: 400;
            color: #333;
        }

        .card-title {
            font-family: 'Roboto', sans-serif;
            font-weight: 500;
            font-size: 22px;
        }

        .overall-chart-container {
            text-align: center;
            margin-bottom: 30px;
            max-width: 70%;
            margin: 0 auto;
        }

        #monthRange {
            width: 100%;
            margin: 10px 0;
        }

        .month-label {
            text-align: center;
        }

        .agent-checkbox {
            display: flex;
            align-items: center;
            margin-right: 10px;
            padding: 8px;
            background-color: #e0e0eb;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .agent-checkbox:hover {
            background-color: #d0d0e0;
        }

        .agent-checkbox label {
            margin-left: 8px;
            font-weight: 500;
        }

        .agent-checkbox input[type="checkbox"] {
            transform: scale(1.2);
            cursor: pointer;
        }

        .agent-checkbox-container {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }

        .agent-checkbox-container label {
            margin: 0 10px;
        }

        .agent-info-container {
            border: 1px solid #ddd;
            padding: 20px;
            margin-top: 20px;
        }

        #overallChart {
            height: 350px;
        }

        .progress {
            height: 20px;
        }

        .status-indicator {
            margin-top: 20px;
            text-align: center;
        }

        #statusText {
            margin-top: 10px;
        }

        /* Style for simulation details box */
        #simulationDetails {
            display: none;
            border: 1px solid #ddd;
            padding: 20px;
            margin-top: 20px;
        }

        #resetBtn {
            display: none;
        }
    </style>
</head>

<body>

    <!-- ======= Header ======= -->
    <header id="header" class="header fixed-top d-flex align-items-center">
        <div class="d-flex align-items-center justify-content-between">
            <a href="index.html" class="logo d-flex align-items-center">
                <span class="d-none d-lg-block">Simulation Setup</span>
            </a>
            <i class="bi bi-list toggle-sidebar-btn"></i>
        </div>
        <nav class="header-nav ms-auto">
            <ul class="d-flex align-items-center">
                <li class="nav-item d-block d-lg-none">
                    <a class="nav-link nav-icon search-bar-toggle " href="#">
                        <i class="bi bi-search"></i>
                    </a>
                </li>
            </ul>
        </nav>
    </header>

    <!-- ======= Sidebar ======= -->
    <aside id="sidebar" class="sidebar">
        <ul class="sidebar-nav" id="sidebar-nav">
            <li class="nav-item">
                <a class="nav-link" href="index.html">
                    <i class="bi bi-grid"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="world-visualization.html">
                    <i class="bi bi-globe"></i>
                    <span>World Data Visualization</span>
                </a>
            </li>

            <li class="nav-item">
                <a class="nav-link " href="overall-agents-visualization.html">
                    <i class="bi bi-grid"></i>
                    <span>Overall Agents Visualization</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="individual-agent.html">
                    <i class="bi bi-person"></i>
                    <span>Individual Agent Income</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="agents-data-visualization.html">
                    <i class="bi bi-bar-chart"></i>
                    <span>Agents Data Visualization</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="occupation-clusters.html">
                    <i class="bi bi-diagram-3"></i>
                    <span>Occupation Clusters</span>
                </a>
            </li>
        </ul>
    </aside>


    <main id="main" class="main">
        <div class="pagetitle">
            <h1>Setup Simulation</h1>
        </div>

        <section class="section">
            <div class="row">
                <div class="col-lg-12">
                    <!-- Simulation Parameters Card -->
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Simulation Parameters</h5>

                            <form id="simulationForm">
                                <!-- Form fields -->
                                <div class="mb-3">
                                    <label for="numAgents" class="form-label">Number of Agents (1-20)</label>
                                    <input type="number" class="form-control" id="numAgents" name="numAgents" min="1"
                                        max="20" required>
                                </div>

                                <div class="mb-3">
                                    <label for="durationYears" class="form-label">Simulation Duration (Years,
                                        1-20)</label>
                                    <input type="number" class="form-control" id="durationYears" name="durationYears"
                                        min="1" max="20" required>
                                </div>

                                <div class="mb-3">
                                    <label for="city" class="form-label">City</label>
                                    <input type="text" class="form-control" id="city" name="city" required>
                                </div>

                                <div class="mb-3">
                                    <label for="startYear" class="form-label">Start Year</label>
                                    <select class="form-select" id="startYear" name="startYear" required>
                                        <option value="2018">2018</option>
                                        <option value="2019">2019</option>
                                        <option value="2020">2020</option>
                                        <option value="2021">2021</option>
                                        <option value="2022">2022</option>
                                        <option value="2023">2023</option>
                                    </select>
                                </div>

                                <button type="submit" class="btn btn-primary">Start Simulation</button>
                            </form>

                            <!-- Status Indicator Section -->
                            <div id="statusIndicator" class="status-indicator" style="display: none;">
                                <!-- Spinner -->
                                <div id="loadingSpinner" class="spinner-border text-primary" role="status"
                                    style="display: none;">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <!-- Progress Bar -->
                                <div id="progressBarContainer" class="progress" style="display: none;">
                                    <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;"
                                        aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <!-- Checkmark (hidden by default) -->
                                <div id="successCheck" style="display: none;">
                                    <i class="bi bi-check-circle-fill" style="font-size: 3rem; color: green;"></i>
                                </div>
                                <!-- Status Text -->
                                <p id="statusText"></p>
                            </div>

                            <!-- Simulation Details Section -->
                            <div id="simulationDetails" style="display: none;">
                                <h5>Simulation Details</h5>
                                <p><strong>Start Year:</strong> <span id="detailsStartYear"></span></p>
                                <p><strong>Duration:</strong> <span id="detailsDuration"></span> years</p>
                                <p><strong>Number of Agents:</strong> <span id="detailsNumAgents"></span></p>
                                <button id="resetBtn" class="btn btn-danger" style="display: none;">Reset
                                    Simulation</button>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/vendor/jquery/jquery.min.js"></script>

    <script>
        let checkInterval;
        let simulationData;
        // Handle form submission
        document.getElementById('simulationForm').addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent default form submission


            // Get form data
            const numAgents = parseInt(document.getElementById('numAgents').value);
            const durationYears = parseInt(document.getElementById('durationYears').value);
            const city = document.getElementById('city').value;
            const startYear = document.getElementById('startYear').value;
            const episodeLength = durationYears * 12;  // Convert years to months

            // Prepare data to send to server
            const data = {
                numAgents: numAgents,
                episodeLength: episodeLength,
                city: city,
                startYear: startYear
            };
            simulationData = data;
            // Show loading spinner and progress bar
            showLoadingSpinner('Simulation is starting...');
            // Send POST request to /start-simulation
            fetch('/start-simulation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
                .then(result => {
                    if (result.status === 'exists') {
                        // Folder already exists, ask user whether to regenerate
                        const regenerate = confirm('Simulation data already exists. Do you want to regenerate?');
                        if (regenerate) {
                            // Send request with 'force': true
                            data.force = true;

                            // Resend request
                            fetch('/start-simulation', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(data)
                            })
                                .then(response => response.json())
                                .then(result => {
                                    if (result.status === 'started') {
                                        startPolling();
                                    } else if (result.status === 'success') {
                                        showSuccessCheck('Simulation completed.');
                                        updateProgressBar(100);
                                        showSimulationDetails();
                                    } else {
                                        hideStatusIndicator();
                                        alert('Error starting simulation.');
                                    }
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    hideStatusIndicator();
                                    alert('Error starting simulation.');
                                });
                        } else {
                            // 用户选择不重新生成，视为模拟已完成
                            showSuccessCheck('Simulation completed.');
                            updateProgressBar(100);
                            showSimulationDetails();
                        }
                    } else if (result.status === 'started') {
                        // Simulation started, start polling
                        startPolling();
                    } else if (result.status === 'success') {
                        // Simulation already completed
                        showSuccessCheck('Simulation completed.');
                        updateProgressBar(100);
                        showSimulationDetails();
                    } else {
                        hideStatusIndicator();
                        alert('Error starting simulation.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    hideStatusIndicator();
                    alert('Error starting simulation.');
                });
        });

        function startPolling() {
            // Clear any existing polling
            if (checkInterval) {
                clearInterval(checkInterval);
            }
            // Poll the server every few seconds to check simulation status
            checkInterval = setInterval(() => {
                fetch('/check-simulation')
                    .then(response => response.json())
                    .then(result => {
                        console.log('Polling result:', result);
                        if (result.status === 'success') {
                            showSuccessCheck('Simulation completed.');
                            updateProgressBar(100);
                            clearInterval(checkInterval);
                            showSimulationDetails();
                        } else if (result.status === 'running') {
                            // Keep showing loading state
                            showLoadingSpinner('Simulation is in progress...');
                        } else if (result.status === 'error') {
                            hideStatusIndicator();
                            clearInterval(checkInterval);
                            alert('An error occurred during the simulation.');
                        } else {
                            hideStatusIndicator();
                            clearInterval(checkInterval);
                            alert('Simulation not started.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        hideStatusIndicator();
                        clearInterval(checkInterval);
                        alert('Error during simulation.');
                    });
            }, 5000); // Poll every 5 seconds
        }

        function showSimulationDetails() {
            const data = simulationData;
            if (!data) {
                console.error('Simulation data is undefined.');
                return;
            }
            document.getElementById('detailsStartYear').innerText = data.startYear || '';
            document.getElementById('detailsDuration').innerText = (data.episodeLength / 12) || '';
            document.getElementById('detailsNumAgents').innerText = data.numAgents || '';
            document.getElementById('simulationDetails').style.display = 'block';
            document.getElementById('resetBtn').style.display = 'inline-block';
        }

        // Listen for Reset Simulation button click
        document.getElementById('resetBtn').addEventListener('click', function () {
            // Send request to /reset-simulation
            fetch('/reset-simulation', {
                method: 'POST'
            })
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'success') {
                        alert('Simulation data has been reset.');
                        // Reset the interface
                        hideStatusIndicator();
                        document.getElementById('simulationDetails').style.display = 'none';
                        document.getElementById('resetBtn').style.display = 'none';
                    } else {
                        alert('Error resetting simulation data.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error resetting simulation data.');
                });
        });

         // Show loading spinner
        function showLoadingSpinner(text) {
            document.getElementById('statusIndicator').style.display = 'block';
            document.getElementById('loadingSpinner').style.display = 'inline-block';
            document.getElementById('progressBarContainer').style.display = 'block';
            document.getElementById('progressBar').classList.add('progress-bar-animated');
            document.getElementById('progressBar').style.width = '100%';
            document.getElementById('successCheck').style.display = 'none';
            document.getElementById('statusText').innerText = text || '';
        }

         // Show success state
         function showSuccessCheck(text) {
            document.getElementById('statusIndicator').style.display = 'block';
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('progressBarContainer').style.display = 'block';
            document.getElementById('progressBar').classList.remove('progress-bar-animated');
            document.getElementById('progressBar').style.width = '100%';
            document.getElementById('successCheck').style.display = 'inline-block';
            document.getElementById('statusText').innerText = text || '';
        }

        // Hide status indicator
        function hideStatusIndicator() {
            document.getElementById('statusIndicator').style.display = 'none';
            document.getElementById('progressBarContainer').style.display = 'none';
        }

        // Update progress bar (here we fill it to 100%)
        function updateProgressBar(progress) {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = progress + '%';
            progressBar.setAttribute('aria-valuenow', progress);
        }
    </script>
</body>

</html>